{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Economic recovery by educational attainment\"\nauthor: \"Andrew Ba Tran\"\ndate: \"July 12, 2016\"\noutput: html_document\n---\n\nThis is the methodology used for the Trend CT story: [Economic recovery leaving behind those who did not go to college](http://trendct.org/2016/07/13/countrys-economic-recovery-leaving-behind-those-who-did-not-go-to-college/).\n\nVisit the [repo](https://github.com/trendct-data/job-gap-educational-attainment/) for the [data](https://github.com/trendct-data/job-gap-educational-attainment/tree/master/data) used in this analysis. (Also, check out the reproducible scripts and data behind many of our other stories in our [central data stories repo](https://github.com/trendct-data))\n\nThe data used in this analysis was either copy and pasted and cleaned by hand from the Census or brought in using the Census API.\n\nWhatâ€™s in this walkthrough\n\nSeveral charts exploring the national and Connecticut-specific employment figures by educational attainment levels.\n\n```{r setup, message=F, warning=F}\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(extrafont)\nlibrary(ggalt)\nlibrary(lubridate)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(stringr)\nlibrary(scales)\nlibrary(gridExtra)\nlibrary(grid)\nlibrary(ggplot2)\n# install.packages(\"devtools\")\n#devtools::install_github(\"hrecht/censusapi\")\nlibrary(\"censusapi\")\n\n# This file contains my census api key\nsource(\"keys.R\")\n\n# Sign up for your own key\n# http://api.census.gov/data/key_signup.html\n```\n\n# National monthly job change\n\n```{r monthly, fig.width=9, fig.height=7, warning=F, message=F}\n# Bringing in US data. Curated from http://www.census.gov/cps/data/cpstablecreator.html\n\nus_change <- read.csv(\"data/us_all_raw.csv\")\nus_change$Date <- paste0(\"1-\", us_change$Date)\nus_change$Date <- dmy(us_change$Date)\n\ncolnames(us_change) <- c(\"Date\", \"Bachelor's degree or higher\", \"Associate's degree or some college\", \"High school or less\")\n\nus_long <- mutate(gather(us_change, area, value, -Date),\n                      area=factor(area, levels=colnames(us_change)[2:4],\n                                  ordered=TRUE))\n\nedu_colors <- c('#66c2a5', '#fc8d62', '#8da0cb')\nnames(edu_colors) <- colnames(us_change)[2:4]\n\nlast_vals <- sapply(colnames(us_change)[2:4], function(x) last(na.exclude(us_change[,x])))\nlast_date <- tail(us_change$Date)#+1 # doing this ^ wld have made it a double\n\n# jobs change (monthly)\n\ngg <- ggplot(us_long)\ngg <- gg + geom_hline(yintercept = 0)\ngg <- gg + geom_line(aes(x=Date, y=value, group=area, color=area))\n#gg <- gg + geom_rect(aes(xmin=as.numeric(ymd(\"2007-12-01\")), xmax=as.numeric(ymd(\"2010-01-01\")), ymin=-Inf, ymax=Inf))\ngg <- gg + annotate(\"rect\", xmin = ymd(\"2007-12-01\"), xmax =ymd(\"2010-01-01\"), ymin = -Inf, ymax = Inf,\n                    alpha = .1)\n\ngg <- gg + scale_color_manual(name=\"\", values=edu_colors)\n#gg <- gg + scale_y_continuous(label=percent)\ngg <- gg + labs(x=NULL, y=\"Employment change (millions)\", title=\"Job change in recession and recovery in the U.S.\",\n                subtitle=\"Workers with more than a high school education gained 11.5 million of the 11.6 million jobs added in the recovery.\",\n                caption=\"SOURCE: U.S. Census CPS, Georgetown Center on Education and the Workforce\")\ngg <- gg + theme_bw(base_family=\"Helvetica\")\ngg <- gg + theme(axis.ticks.y=element_blank())\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(legend.key=element_blank())\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Black\", size=22))\ngg <- gg + theme(plot.caption=element_text(face=\"bold\", family=\"Lato\", size=9, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + geom_label(data=us_long, aes(x=ymd(\"2008-4-01\"), y=5, label=\"Recession\", hjust=0),\n                      family=\"Helvetica\", lineheight=0.95,\n                      size=5, label.size=0, color=\"#2b2b2b\")\ngg <- gg + geom_label(data=us_long, aes(x=ymd(\"2010-4-01\"), y=5, label=\"Recovery\", hjust=0),\n                      family=\"Helvetica\", lineheight=0.95,\n                      size=5, label.size=0, color=\"#2b2b2b\")\ngg <- gg + theme(legend.position=\"none\")\ngg <- gg + theme(plot.margin = unit(c(1, 15, 1, 1), \"lines\"))\ngg\n\n\nfor (i in 1:length(last_vals)) {\n  gg <- gg + annotation_custom(grob=textGrob(paste0(names(last_vals)[i], \" (\", round(last_vals[i],1), \")\"), hjust=-.3,\n                                             gp=gpar(fontsize=10, \n                                                     col=edu_colors[names(last_vals)[i]])),\n                               xmin=as.numeric(last_date[i]),xmax=as.numeric(last_date[i]),\n                               ymin=last_vals[i], ymax=last_vals[i])\n}\n\ngb <- ggplot_build(gg)\ngt <- ggplot_gtable(gb)\n\ngt$layout$clip[gt$layout$name==\"panel\"] <- \"off\"\ngrid.draw(gt)\n\n```\n\n# Connecticut annual job change\n\n\n```{r ct_only, fig.width=9, fig.height=7, warning=F, message=F}\n# These Census IDs are what we're pulling from the Census API\n\n# B23006_001E - Total\n# B23006_002E - Less than high school graduate\n# B23006_009E - High school graduate (includes equivalency)\n# B23006_016E - Some college or associate's degree\n# B23006_023E - Bachelor's degree or higher\n\n# Function from censusapi to pull 2009 data\n# Replace `census_key` with your individual API key\n\ndata2009 <- getCensus(name=\"acs5\", \n                      vintage=2009,\n                      key=census_key, \n                      vars=c(\"NAME\", \"B23006_002E\",\n                             \"B23006_009E\", \"B23006_016E\", \"B23006_023E\"), \n                      region=\"state:*\")\n\n# adding year identifier for future joining\n\ndata2009$state <- 2009\n\n# Cleaning up the column names\ncolnames(data2009) <- c(\"state\", \"year\", \"Less than high school graduate\", \"High school graduate\", \"Some college or associate's degree\", \"Bachelor's degree or higher\")\n\n# Some math\ndata2009$`High school or less` <- data2009$`High school graduate` + data2009$`Less than high school graduate`\n\n# Deleting unnecessary columns\ndata2009[,3] <- NULL\ndata2009[,3] <- NULL\n\n# Restructuring the data for joining\ndata2009 <- data2009 %>%\n  gather(\"category\", \"total\", 3:5)\n\n# Function from censusapi to pull 2010 data\n# Most of what flows below is the same as the code above but for a different year\n# Probably would be more efficient to write a loop to compile this but it's too late now\n\ndata2010 <- getCensus(name=\"acs5\", \n                      vintage=2010,\n                      key=census_key, \n                      vars=c(\"NAME\", \"B23006_002E\",\n                             \"B23006_009E\", \"B23006_016E\", \"B23006_023E\"), \n                      region=\"state:*\")\ndata2010$state <- 2010\ncolnames(data2010) <- c(\"state\", \"year\", \"Less than high school graduate\", \"High school graduate\", \"Some college or associate's degree\", \"Bachelor's degree or higher\")\ndata2010$`High school or less` <- data2010$`High school graduate` + data2010$`Less than high school graduate`\ndata2010[,3] <- NULL\ndata2010[,3] <- NULL\n\ndata2010 <- data2010 %>%\n  gather(\"category\", \"total\", 3:5)\n\ndata2011 <- getCensus(name=\"acs5\", \n                      vintage=2011,\n                      key=census_key, \n                      vars=c(\"NAME\", \"B23006_002E\",\n                             \"B23006_009E\", \"B23006_016E\", \"B23006_023E\"), \n                      region=\"state:*\")\ndata2011$state <- 2011\ncolnames(data2011) <- c(\"state\", \"year\", \"Less than high school graduate\", \"High school graduate\", \"Some college or associate's degree\", \"Bachelor's degree or higher\")\ndata2011$`High school or less` <- data2011$`High school graduate` + data2011$`Less than high school graduate`\ndata2011[,3] <- NULL\ndata2011[,3] <- NULL\n\ndata2011 <- data2011 %>%\n  gather(\"category\", \"total\", 3:5)\n\ndata2012 <- getCensus(name=\"acs5\", \n                      vintage=2012,\n                      key=census_key, \n                      vars=c(\"NAME\", \"B23006_002E\",\n                             \"B23006_009E\", \"B23006_016E\", \"B23006_023E\"), \n                      region=\"state:*\")\ndata2012$state <- 2012\ncolnames(data2012) <- c(\"state\", \"year\", \"Less than high school graduate\", \"High school graduate\", \"Some college or associate's degree\", \"Bachelor's degree or higher\")\ndata2012$`High school or less` <- data2012$`High school graduate` + data2012$`Less than high school graduate`\ndata2012[,3] <- NULL\ndata2012[,3] <- NULL\n\ndata2012 <- data2012 %>%\n  gather(\"category\", \"total\", 3:5)\n\ndata2013 <- getCensus(name=\"acs5\", \n                      vintage=2013,\n                      key=census_key, \n                      vars=c(\"NAME\", \"B23006_002E\",\n                             \"B23006_009E\", \"B23006_016E\", \"B23006_023E\"), \n                      region=\"state:*\")\n\ndata2013$state <- 2013\ncolnames(data2013) <- c(\"state\", \"year\", \"Less than high school graduate\", \"High school graduate\", \"Some college or associate's degree\", \"Bachelor's degree or higher\")\ndata2013$`High school or less` <- data2013$`High school graduate` + data2013$`Less than high school graduate`\ndata2013[,3] <- NULL\ndata2013[,3] <- NULL\n\ndata2013 <- data2013 %>%\n  gather(\"category\", \"total\", 3:5)\n\n\ndata2014 <- getCensus(name=\"acs5\", \n                      vintage=2014,\n                      key=census_key, \n                      vars=c(\"NAME\", \"B23006_002E\",\n                             \"B23006_009E\", \"B23006_016E\", \"B23006_023E\"), \n                      region=\"state:*\")\n\ndata2014$state <- 2014\ncolnames(data2014) <- c(\"state\", \"year\", \"Less than high school graduate\", \"High school graduate\", \"Some college or associate's degree\", \"Bachelor's degree or higher\")\ndata2014$`High school or less` <- data2014$`High school graduate` + data2014$`Less than high school graduate`\ndata2014[,3] <- NULL\ndata2014[,3] <- NULL\n\ndata2014 <- data2014 %>%\n  gather(\"category\", \"total\", 3:5)\n\n\ndata_0914 <- rbind(data2009, data2010, data2011, data2012, data2013, data2014)\n\n# If you want to filter by another state, do so below\n\nct_data <- data_0914 %>%\n  filter(state==\"Connecticut\")\n\nct_data2 <- ct_data %>%\n  spread(category, total)\n\nbach_base <- ct_data2[1,3]\nhs_base <- ct_data2[1,4]\nsome_base <- ct_data2[1,5]\n\nct_data3 <- ct_data2\nct_data3[,3] <- ct_data2[,3] - bach_base\nct_data3[,4] <- ct_data2[,4] - hs_base\nct_data3[,5] <- ct_data2[,5] - some_base\nct_data3 <- ct_data3 %>%\n  gather(\"category\", \"total\", 3:5)\n\nct_colors <- c('#66c2a5', '#8da0cb', '#fc8d62'  )\nnames(ct_colors) <- unique(ct_data3$category)\n\ngg <- ggplot(ct_data3)\ngg <- gg + geom_hline(yintercept = 0)\ngg <- gg + geom_line(aes(x=year, y=total, group=category, color=category))\n#gg <- gg + geom_rect(aes(xmin=as.numeric(ymd(\"2007-12-01\")), xmax=as.numeric(ymd(\"2010-01-01\")), ymin=-Inf, ymax=Inf))\ngg <- gg + annotate(\"rect\", xmin = 2009, xmax =2010, ymin = -Inf, ymax = Inf,\n                    alpha = .1)\ngg <- gg + scale_color_manual(name=\"\", values=ct_colors)\n#gg <- gg + scale_y_continuous(label=percent)\ngg <- gg + labs(x=NULL, y=\"Jobs\", title=\"Job change in recession and recovery in Connecticut\",\n                subtitle=\"Connecticut mirrors the rest of the country for education levels.\",\n                caption=\"SOURCE: U.S. Census ACS 5-year\")\ngg <- gg + theme_bw(base_family=\"Helvetica\")\ngg <- gg + theme(axis.ticks.y=element_blank())\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(legend.key=element_blank())\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Black\", size=22))\ngg <- gg + theme(plot.caption=element_text(face=\"bold\", family=\"Lato\", size=9, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + geom_label(data=ct_data3, aes(x=2009, y=40000, label=\"Recession\", hjust=-.1),\n                      family=\"Helvetica\", lineheight=0.95,\n                      size=5, label.size=0, color=\"#2b2b2b\")\ngg <- gg + geom_label(data=ct_data3, aes(x=2010, y=40000, label=\"Recovery\", hjust=-.2),\n                      family=\"Helvetica\", lineheight=0.95,\n                      size=5, label.size=0, color=\"#2b2b2b\")\ngg <- gg + theme(legend.position=\"none\")\ngg <- gg + theme(plot.margin = unit(c(1, 15, 1, 1), \"lines\"))\n\ngg <- gg + annotation_custom(grob=textGrob(\"High school or less (-14k)\", hjust=.5,\n                                           gp=gpar(fontsize=10, \n                                                   col='#8da0cb')),\n                             xmin=2015,xmax=2015,\n                             ymin=-14053, ymax=-14053)\ngg <- gg + annotation_custom(grob=textGrob(\"Bachelor's degree or higher (48k)\", hjust=.50,  \n                                           gp=gpar(fontsize=10, \n                                                   col='#66c2a5')),\n                             xmin=2015,xmax=2015,\n                             ymin=48432, ymax=48432)\ngg <- gg + annotation_custom(grob=textGrob(\"Associate's degree or some college (21k)\", hjust=.30,  \n                                           gp=gpar(fontsize=10, \n                                                   col='#fc8d62')),\n                             xmin=2015,xmax=2015,\n                             ymin=20722, ymax=20722)\ngb <- ggplot_build(gg)\n\ngt <- ggplot_gtable(gb)\n\ngt$layout$clip[gt$layout$name==\"panel\"] <- \"off\"\ngrid.draw(gt)\n\n```\n\n```{r us_total, fig.width=9, fig.height=7, warning=F, message=F}\n# Bringing in US data. Curated from http://www.census.gov/cps/data/cpstablecreator.html\n\nus <- read.csv(\"data/education_jobs_us.csv\")\n\n# Cleaning up the columns\nus <- us[c(\"Year\",\"Type\",\"Totals\", \"Children.under.15\",\"No.high.school.diploma\",\n           \"High.school.or.equivalent\",\"Some.college..less.than.4.yr.degree\",\"Bachelor.s.degree.or.higher\" )]\n\n# Formatting the numbers to eliminate the commas, convert to numeric\nus$Totals <- gsub(\",\", \"\", us$Totals)\nus$Totals <- as.numeric(us$Totals)\nus$Children.under.15 <- gsub(\",\", \"\", us$Children.under.15)\nus$Children.under.15 <- as.numeric(us$Children.under.15)\nus$No.high.school.diploma <- gsub(\",\", \"\", us$No.high.school.diploma)\nus$No.high.school.diploma <- as.numeric(us$No.high.school.diploma)\nus$High.school.or.equivalent <- gsub(\",\", \"\", us$High.school.or.equivalent)\nus$High.school.or.equivalent <- as.numeric(us$High.school.or.equivalent)\nus$Some.college..less.than.4.yr.degree <- gsub(\",\", \"\", us$Some.college..less.than.4.yr.degree)\nus$Some.college..less.than.4.yr.degree <- as.numeric(us$Some.college..less.than.4.yr.degree)\nus$Bachelor.s.degree.or.higher <- gsub(\",\", \"\", us$Bachelor.s.degree.or.higher)\nus$Bachelor.s.degree.or.higher <- as.numeric(us$Bachelor.s.degree.or.higher)\n\n# Years came in an awkward format, so fixing\nus$year <- round(us$Year,0)\n\n# Cleaning up and narrowing the data\nus_all <- us %>%\n  filter(Type==\"Employed\") %>%\n  mutate(hs_or_less=No.high.school.diploma+High.school.or.equivalent, some_college=Some.college..less.than.4.yr.degree) %>%\n  select(year, hs_or_less, some_college, Bachelor.s.degree.or.higher)\n\n# Restructuring the data in a way that will make it graphable with ggplot2\nus_all2 <- us_all %>%\n  gather(\"type\", \"employed\", 2:4)\n\nus_all2$type <- gsub(\"Bachelor.s.degree.or.higher\", \"Bachelor's degree or higher\", us_all2$type)\nus_all2$type <- gsub(\"hs_or_less\", \"High school or less\", us_all2$type)\nus_all2$type <- gsub(\"some_college\", \"Associate's degree or some college\", us_all2$type)\n\n# #8da0cb blue\n# #66c2a5 green\n# #fc8d62 red\n\nus_colors <- c('#66c2a5', '#fc8d62', '#8da0cb'  )\n\nnames(us_colors) <- unique(us_change$type)\n\n#edu_colors <- c('#66c2a5', '#fc8d62', '#8da0cb')\nnames(us_colors) <- colnames(us_change)[2:4]\n\nlast_vals <- sapply(colnames(us_all)[2:4], function(x) last(na.exclude(us_all[,x])))\nlast_date <- tail(us_all$year,1) # doing this ^ wld have made it a double\n\nus_hs_2015 <- tail(us_all$hs_or_less,1)\nus_sc_2015 <- tail(us_all$some_college ,1)\nus_bd_2015 <- tail(us_all$Bachelor.s.degree.or.higher,1)\n\ngg <- ggplot(us_all2)\ngg <- gg + geom_line(aes(x=year, y=employed, group=type, color=type))\ngg <- gg + annotate(\"rect\", xmin = 2008, xmax =2010, ymin = -Inf, ymax = Inf,\n                    alpha = .1)\ngg <- gg + scale_color_manual(name=\"\", values=us_colors)\ngg <- gg + labs(x=NULL, y=\"Jobs (millions)\", title=\"Job change in recession and recovery in the U.S.\",\n                subtitle=\"For the first time, workers with a Bachelor's degree or higher make up a larger share of the workforce (36%) \\nthan those with a high school diplomar or less (34%)\",\n                caption=\"SOURCE: U.S. Census CPS, Georgetown Center on Education and the Workforce\")\ngg <- gg + theme_bw(base_family=\"Helvetica\")\ngg <- gg + theme(axis.ticks.y=element_blank())\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(legend.key=element_blank())\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Black\", size=22))\ngg <- gg + theme(plot.caption=element_text(face=\"bold\", family=\"Lato\", size=9, color=\"gray\", margin=margin(t=10, r=80)))\ngg <- gg + geom_label(data=us, aes(x=2008, y=max(us_all2$employed) - max(us_all2$employed)*.15, label=\"Recession\", hjust=-.1),\n                      family=\"Helvetica\", lineheight=0.95,\n                      size=5, label.size=0, color=\"#2b2b2b\")\ngg <- gg + geom_label(data=us, aes(x=2010, y=max(us_all2$employed) - max(us_all2$employed)*.15, label=\"Recovery\", hjust=-.2),\n                      family=\"Helvetica\", lineheight=0.95,\n                      size=5, label.size=0, color=\"#2b2b2b\")\ngg <- gg + theme(legend.position=\"none\")\ngg <- gg + theme(plot.margin = unit(c(1, 15, 1, 1), \"lines\"))\ngg <- gg + annotation_custom(grob=textGrob(paste0(\"High school or less (\", us_hs_2015, \")\"), hjust=-.3,\n                                           gp=gpar(fontsize=10, \n                                                   col='#8da0cb')),\n                             xmin=2015,xmax=2015,\n                             ymin=us_hs_2015-500, ymax=us_hs_2015-500)\ngg <- gg + annotation_custom(grob=textGrob(paste0(\"Associate's degree or some college (\", us_sc_2015, \")\"), hjust=-.17,\n                             gp=gpar(fontsize=10, \n                                     col='#fc8d62')),\nxmin=2015,xmax=2015,\nymin=us_sc_2015, ymax=us_sc_2015)\ngg <- gg + annotation_custom(grob=textGrob(paste0(\"Bachelor's degree or higher (\", us_bd_2015, \")\"), hjust=-.20,  \n                             gp=gpar(fontsize=10, \n                                     col='#66c2a5')),\nxmin=2015,xmax=2015,\nymin=us_bd_2015+500, ymax=us_bd_2015+500)\ngg\ngb <- ggplot_build(gg)\n\ngt <- ggplot_gtable(gb)\n\ngt$layout$clip[gt$layout$name==\"panel\"] <- \"off\"\ngrid.draw(gt)\n\n```",
    "created" : 1473696273675.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2594365257",
    "id" : "9037A648",
    "lastKnownWriteTime" : 1473696554,
    "last_content_update" : 1473696554451,
    "path" : "~/Documents/Github/trendct-data/2016/07/job-gap-educational-attainment/index.Rmd",
    "project_path" : "index.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}